<app-side-nav>
    <div class="admin-page">
        <div class="admin-header">
        <h1 class="admin-title">Admin Dashboard</h1>
        <p class="admin-subtitle">Lecture seule â€¢ indicateurs & supervision</p>
        </div>

        <div class="loader" *ngIf="(loading$ | async)">
        <mat-spinner></mat-spinner>
        </div>

        <p class="error-text" *ngIf="(error$ | async) as err">{{ err }}</p>

        <!-- KPI -->
        <ng-container *ngIf="(summary$ | async) as s">
        <div class="kpi-grid">
            <mat-card class="kpi-card">
            <div class="kpi-label">Total orders</div>
            <div class="kpi-value">{{ s.totalOrders }}</div>
            </mat-card>

            <mat-card class="kpi-card">
            <div class="kpi-label">Revenue</div>
            <div class="kpi-value">{{ s.revenue | currency:'CHF ' }}</div>
            </mat-card>

            <mat-card class="kpi-card">
            <div class="kpi-label">Avg basket</div>
            <div class="kpi-value">{{ s.avgBasket | currency:'CHF ' }}</div>
            </mat-card>
        </div>

        <mat-card class="panel">
            <h2 class="panel-title">Top products</h2>
            <div class="top-products">
            <div class="top-row" *ngFor="let p of s.topProducts">
                <span class="top-name">{{ p.name }}</span>
                <span class="top-qty">{{ p.qty }} sold</span>
            </div>
            </div>
        </mat-card>
        </ng-container>

        <!-- Recent orders -->
        <mat-card class="panel">
        <h2 class="panel-title">Recent orders</h2>

        <table mat-table [dataSource]="(recentOrders$ | async) ?? []" class="admin-table">
            <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let o">{{ o.id }}</td>
            </ng-container>

            <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let o">{{ o.createdAt | date:'short' }}</td>
            </ng-container>

            <ng-container matColumnDef="itemsCount">
            <th mat-header-cell *matHeaderCellDef>Items</th>
            <td mat-cell *matCellDef="let o">{{ o.itemsCount }}</td>
            </ng-container>

            <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let o">{{ o.total | currency:'CHF ' }}</td>
            </ng-container>

            <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let o">{{ o.status }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedOrdersColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedOrdersColumns"></tr>
        </table>
        </mat-card>

        <!-- Low stock -->
        <mat-card class="panel">
        <h2 class="panel-title">Low stock alerts</h2>

        <table mat-table [dataSource]="(lowStock$ | async) ?? []" class="admin-table">
            <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Product</th>
            <td mat-cell *matCellDef="let p">
                <div class="stock-name">{{ p.name }}</div>
                <div class="stock-label" [ngClass]="stockClass(p.stock, p.lowStockThreshold)">
                {{ stockLabel(p.stock, p.lowStockThreshold) }}
                </div>
            </td>
            </ng-container>

            <ng-container matColumnDef="stock">
            <th mat-header-cell *matHeaderCellDef>Stock</th>
            <td mat-cell *matCellDef="let p">{{ p.stock }}</td>
            </ng-container>

            <ng-container matColumnDef="threshold">
            <th mat-header-cell *matHeaderCellDef>Threshold</th>
            <td mat-cell *matCellDef="let p">{{ p.lowStockThreshold }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedLowStockColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedLowStockColumns"></tr>
        </table>
        </mat-card>
    </div>
</app-side-nav>