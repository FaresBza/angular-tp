<app-side-nav>
  <div class="rating-page">
  <mat-card class="rating-card">
    <div *ngIf="product$ | async as product" class="rating-content">
      <div class="header-btn">
        <button class="back-button" (click)="returnToProductsPage()">&lt;</button>
        <span class="rating-value" *ngIf="rating$ | async as rating">{{ rating.product_id }}</span>
      </div>
      <div class="rating-header">
          <div class="rating-header-main" >
            <h1 class="product-title">{{ product.name }}</h1>
  
          </div>
        <p class="product-subtitle">
          Track customer satisfaction and see how this product is performing in real time.
        </p>
      </div>

      <ng-container *ngIf="rating$ | async as rating">
        <div class="rating-stars-row" *ngIf="rating.avg_rating !== null">
          <div class="stars">
            <ng-container *ngFor="let star of [1,2,3,4,5]; let i = index">
              <span
                class="star"
                [ngClass]="{ 'filled': i < Math.round(rating.avg_rating) }"
              >
                &#9733;
              </span>
            </ng-container>
          </div>

          <span class="rating-score">
            {{ rating.avg_rating.toFixed(1) }}/5
          </span>

          <span class="rating-count">
            {{ rating.count }} customer reviews
          </span>
        </div>

        <div class="rating-info-panel">
          <ul class="rating-bullets">
            <li>
              <span class="bullet-dot"></span>
              Average rating based on real customer feedback.
            </li>
            <li>
              <span class="bullet-dot"></span>
              {{ rating.count }} verified votes recorded.
            </li>
            <li>
              <span class="bullet-dot"></span>
              Updated each time a new rating is submitted.
            </li>
          </ul>
        </div>
      </ng-container>

      <div class="rating-error" *ngIf="error$ | async as error">
        <p class="error-text">{{ error }}</p>
      </div>

      <div class="rating-footer">

        <div class="rating-actions">
          <button
            mat-raised-button
            class="primary-cta"
            (click)="addToCart(product)"
          >
            ADD TO CART / {{ product.price | currency: 'CHF '}}.-
          </button>
        </div>
      </div>
    </div>
  </mat-card>
  <mat-card  class="reviews-card">
    <section *ngIf="product$ | async as product" class="reviews-content">
        <div class="reviews-title-row">
          <h2 class="product-title">Customer reviews</h2>

          <div class="reviews-meta">
            <span class="avg">
              {{ (avgReviewRating$ | async) | number : '1.1-1' }}/5
            </span>
            <span class="count">
              ({{ (reviewCount$ | async) ?? 0 }} review(s))
            </span>
          </div>
        </div>

        <div *ngIf="(reviewsLoading$ | async)" class="reviews-loading">
          Loading reviews...
        </div>

        <p class="error-text" *ngIf="(reviewsError$ | async) as rerr">
          {{ rerr }}
        </p>

        <ul class="reviews-list" *ngIf="(reviews$ | async) as reviews">
          <li
            class="review-item"
            *ngFor="let r of reviews; trackBy: trackByReviewId"
          >
            <div class="review-top">
              <strong>{{ r.user }}</strong>

              <span class="review-stars">
                <ng-container *ngFor="let s of [1,2,3,4,5]; let i = index">
                  <span
                    class="star"
                    [ngClass]="{ 'filled': i < r.rating }"
                  >
                    &#9733;
                  </span>
                </ng-container>
              </span>

              <span class="date">
                {{ r.createdAt | date : 'short' }}
              </span>
            </div>

            <p class="comment">{{ r.comment }}</p>
          </li>

          <li class="review-empty" *ngIf="!reviews.length">
            No reviews yet. Be the first one!
          </li>
        </ul>

        <form
          class="review-form"
          [formGroup]="reviewForm"
          (ngSubmit)="submitReview(product.id)"
        >
          <h3>Leave a review</h3>

          <div class="review-form-row">
            <mat-form-field appearance="outline" class="rating-field">
              <mat-label>Rating</mat-label>
              <mat-select formControlName="rating">
                <mat-option *ngFor="let r of [1,2,3,4,5]" [value]="r">
                  {{ r }} â˜…
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="comment-field">
              <mat-label>Comment</mat-label>
              <textarea
                matInput
                rows="3"
                formControlName="comment"
              ></textarea>
            </mat-form-field>
          </div>

          <button mat-raised-button color="primary" type="submit">
            Submit review
          </button>
        </form>
      </section>
  </mat-card>
</div>

</app-side-nav>