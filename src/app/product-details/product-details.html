<app-side-nav>
  <div class="rating-page">
  <mat-card class="rating-card" *ngIf="(product$ | async) as product">
    <div class="header-btn">
      <button
        mat-icon-button
        class="back-button"
        (click)="returnToProductsPage()"
        aria-label="Back to products"
      >
        &lt;
      </button>

      <button
        mat-icon-button
        class="back-button"
        (click)="toggleWishlist(product.id, $event)"
        aria-label="Toggle wishlist"
      >
        <mat-icon>
          {{ (isInWishlist$ | async) ? 'favorite' : 'favorite_border' }}
        </mat-icon>
      </button>
    </div>

    <div class="rating-content">
      <div class="rating-header">
        <div class="rating-header-main">
          <h1 class="product-title">{{ product.name }}</h1>
        </div>

        <p class="product-subtitle">
          Price: <strong>{{ product.price | currency : 'CHF ' }}.-</strong>
        </p>
      </div>

      <div *ngIf="(loading$ | async)" class="loader">
        <mat-spinner></mat-spinner>
      </div>

      <div class="rating-error" *ngIf="(error$ | async) as error">
        <p class="error-text">{{ error }}</p>
      </div>

      <div class="rating-stars-row" *ngIf="(displayRating$ | async) as rating">
        <div class="stars">
          <ng-container *ngFor="let star of [1,2,3,4,5]; let i = index">
            <span
              class="star"
              [style.--fill.%]="getStarFillPercent(rating.avg_rating, i)"
            >
              &#9733;
            </span>
          </ng-container>
        </div>

        <span class="rating-score">
          {{ rating.avg_rating | number : '1.1-1' }}/5
        </span>

        <span class="rating-count">
          ({{ rating.count }} {{ rating.source === 'reviews' ? 'review(s)' : 'vote(s)' }})
        </span>
      </div>


      <div class="rating-info-panel">
        <ul class="rating-bullets">
          <li>
            <span class="bullet-dot"></span>
            Average rating based on real customer feedback.
          </li>
          <li>
            <span class="bullet-dot"></span>
            Updated each time a new rating is submitted.
          </li>
        </ul>
      </div>

      <div class="rating-footer">
        <div class="rating-actions">
          <button mat-raised-button class="primary-cta" (click)="addToCart(product)">
            ADD TO CART / CHF {{ product.price | number : '1.2-2' }}.-
          </button>
        </div>
      </div>
    </div>
  </mat-card>
  <mat-card class="reviews-card" *ngIf="(product$ | async) as product">
    <div class="rating-header">
        <div class="rating-header-main">
          <h2 class="product-title" style="font-size: 1.35rem; margin-bottom: 10px;">
            Customer reviews
          </h2>

          <div class="rating-value">
            {{ (avgReviewRating$ | async) | number : '1.1-1' }}
          </div>
        </div>

        <p class="product-subtitle">
          ({{ (reviewCount$ | async) ?? 0 }} review(s))
        </p>
      </div>

      <div class="rating-info-panel" *ngIf="(reviewsLoading$ | async)">
        <ul class="rating-bullets">
          <li>
            <span class="bullet-dot"></span>
            Loading reviews...
          </li>
        </ul>
      </div>

      <div class="rating-error" *ngIf="(reviewsError$ | async) as rerr">
        <p class="error-text">{{ rerr }}</p>
      </div>

      <div *ngIf="(reviews$ | async) as reviews">
        <div
          class="rating-info-panel"
          *ngFor="let r of reviews; trackBy: trackByReviewId"
          style="margin-bottom: 12px;"
        >
          <div class="rating-stars-row" style="margin-bottom: 8px;">
            <strong style="color:#111827;">{{ r.user }}</strong>

            <div class="stars" style="margin-left: 10px;">
              <ng-container *ngFor="let star of [1,2,3,4,5]; let i = index">
                <span class="star" [ngClass]="{ filled: i < r.rating }">
                  &#9733;
                </span>
              </ng-container>
            </div>

            <span class="rating-count" style="margin-left:auto;">
              {{ r.createdAt | date : 'short' }}
            </span>
          </div>

          <p class="product-subtitle" style="margin:0; color:#374151;">
            {{ r.comment }}
          </p>
        </div>

        <div class="rating-info-panel" *ngIf="!reviews.length">
          <ul class="rating-bullets">
            <li>
              <span class="bullet-dot"></span>
              No reviews yet. Be the first one!
            </li>
          </ul>
        </div>
      </div>

      <div class="rating-info-panel" style="margin-top: 10px;">
  <form [formGroup]="reviewForm" (ngSubmit)="submitReview(product.id)">
    <ul class="rating-bullets" style="margin-bottom: 10px;">
      <li>
        <span class="bullet-dot"></span>
        Leave a review
      </li>
    </ul>

    <div
      class="stars interactive-stars"
      (mouseleave)="clearHover()"
      style="margin-bottom: 12px;"
    >
      <ng-container *ngFor="let star of [1,2,3,4,5]; let i = index">
        <button
          type="button"
          class="star clickable"
          [style.--fill.%]="
            getStarFillPercent(
              hoverRating || selectedRating,
              i
            )
          "
          (mouseenter)="setHover(i + 1)"
          (focus)="setHover(i + 1)"
          (blur)="clearHover()"
          (click)="setRating(i + 1)"
          [attr.aria-label]="'Rate ' + (i + 1) + ' star(s)'"
        >
          &#9733;
        </button>
      </ng-container>
    </div>

    <mat-form-field appearance="outline" style="width:100%; margin-bottom: 10px;">
      <mat-label>Comment*</mat-label>
      <textarea matInput rows="3" formControlName="comment"></textarea>
    </mat-form-field>

    <div class="rating-error" *ngIf="reviewForm.touched && reviewForm.invalid">
      <p class="error-text">
        Please provide a comment (min 5 characters).
      </p>
    </div>

    <button
      mat-raised-button
      class="primary-cta"
      type="submit"
      [disabled]="reviewForm.invalid"
    >
      Submit review
    </button>
  </form>
</div>

  </mat-card>
</div>

</app-side-nav>