<app-side-nav>
    <div class="products-page">
    <div *ngIf="notification" class="products-notification">
        {{ notification }}
    </div>
    <header class="header">
        <h2 class="main-title">My Shop - Products</h2>
        <button class="cart-button" type="button" (click)="goToCartPage()">
            <mat-icon>shopping_cart</mat-icon>
            <ng-container *ngIf="(carCount$ | async) as count">
                <span
                    class="cart-badge"
                    *ngIf="count > 0"
                >
                    {{ count }}
                </span>
            </ng-container>
        </button>
    </header>
    <mat-card class="filters-card">


        <form [formGroup]="filters" (ngSubmit)="onSearch()" class="filters-grid">

        <mat-form-field appearance="outline">
            <mat-label>Min rating</mat-label>
            <input matInput type="number" formControlName="minRating" />
        </mat-form-field>

        <mat-form-field appearance="outline">
            <mat-label>Ordering</mat-label>
            <mat-select formControlName="ordering">
            <mat-option value="-created_at">Newest first</mat-option>
            <mat-option value="created_at">Oldest first</mat-option>
            <mat-option value="-price">Price ↓</mat-option>
            <mat-option value="price">Price ↑</mat-option>
            </mat-select>
        </mat-form-field>

        <button mat-raised-button color="primary" type="submit">
            Apply
        </button>
        </form>

        <div class="status-row">
        <div *ngIf="loading$ | async" class="spinner-wrapper">
            <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
        </div>

        <p *ngIf="error$ | async as error" class="error-text">
            {{ error }}
        </p>

        <p class="count-text">Total: {{ count$ | async }}</p>
        </div>
    </mat-card>
    <mat-card class="table-card table-scrollable">
        <table mat-table [dataSource]="(products$ | async) || []" class="mat-elevation-z2">
            <ng-container matColumnDef="wishlist">
                <th mat-header-cell *matHeaderCellDef>Wishlist</th>
                <td mat-cell *matCellDef="let p">
                    <ng-container *ngIf="(wishlistIds$ | async) as wishlistIds">
                    <button
                        mat-icon-button
                        (click)="toggleWishlist(p.id, $event)"
                    >
                        <mat-icon [class.red]="isInWishlist(p.id, wishlistIds)">
                        {{ isInWishlist(p.id, wishlistIds) ? 'favorite' : 'favorite_border' }}
                        </mat-icon>
                    </button>
                    </ng-container>
                </td>
            </ng-container>

        <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let p">{{ p.id }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let p">{{ p.name }}</td>
        </ng-container>

        <ng-container matColumnDef="price">
            <th mat-header-cell *matHeaderCellDef>Price</th>
            <td mat-cell *matCellDef="let p">{{ p.price | currency: 'CHF '}}.-</td>
        </ng-container>

        <ng-container matColumnDef="created_at">
            <th mat-header-cell *matHeaderCellDef>Created at</th>
            <td mat-cell *matCellDef="let p">{{ p.created_at }}</td>
        </ng-container>

        <ng-container matColumnDef="avg">
            <th mat-header-cell *matHeaderCellDef>Rating</th>
            <td mat-cell *matCellDef="let p">
            {{ p._avg != null ? p._avg.toFixed(1) : '-' }}/5
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            (click)="goToRatingProductPage(row.id)"
            (keydown.enter)="goToRatingProductPage(row.id)"
            class="clickable-row"
        ></tr>
        </table>
        <mat-paginator
            [length]="(count$ | async) ?? 0"
            [pageSize]="filters.value.pageSize"
            [pageSizeOptions]="[5, 10, 25, 100]"
            aria-label="Select page"
            (page)="onPaginationChange($event)">
        </mat-paginator>
    </mat-card>
</div>

</app-side-nav>